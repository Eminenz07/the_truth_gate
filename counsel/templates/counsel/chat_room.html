{% extends 'core/base.html' %} {% block title %}Chat | The Truth Gate{% endblock
%} {% block extra_css %}
<style>
  .chat-container {
    max-width: 800px;
    margin: 0 auto;
    height: calc(100vh - 200px);
    min-height: 500px;
    display: flex;
    flex-direction: column;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
  }

  .chat-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: #f8fafc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .message {
    max-width: 75%;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    line-height: 1.5;
  }

  .message.sent {
    align-self: flex-end;
    background: var(--text-primary);
    color: white;
    border-bottom-right-radius: 4px;
  }

  .message.received {
    align-self: flex-start;
    background: #f1f5f9;
    color: var(--text-primary);
    border-bottom-left-radius: 4px;
  }

  .message-time {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-top: 0.25rem;
  }

  .chat-input {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    background: #f8fafc;
    display: flex;
    gap: 0.75rem;
  }

  .chat-input input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 25px;
    font-size: 1rem;
    outline: none;
  }

  .chat-input input:focus {
    border-color: var(--primary);
  }

  .chat-input button {
    padding: 0.75rem 1.5rem;
    background: var(--text-primary);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1rem;
  }

  .chat-input button:hover {
    background: var(--primary-dark);
  }

  .empty-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    text-align: center;
    padding: 2rem;
  }

  .empty-chat i {
    font-size: 3rem;
    opacity: 0.5;
    margin-bottom: 1rem;
  }
</style>
{% endblock %} {% block content %}
<div class="chat-container">
  <div class="chat-header">
    <div>
      <strong style="font-family: var(--font-heading)">
        {% if is_counsellor %} Chat with {{
        conversation.user.get_full_name|default:conversation.user.username }} {%
        else %} {% if conversation.counsellor %} Counsellor: {{
        conversation.counsellor.get_full_name|default:conversation.counsellor.username
        }} {% else %} Waiting for a counsellor... {% endif %} {% endif %}
      </strong>
      <div style="font-size: 0.8rem; color: var(--text-secondary)">
        {% if conversation.retention_mode == '24h' %}
        <i class="fas fa-clock"></i> Messages auto-delete after 24 hours {% else
        %} <i class="fas fa-lock"></i> Confidential conversation {% endif %}
      </div>
    </div>
    <a
      href="{% url 'counsel:home' %}"
      style="color: var(--text-secondary); text-decoration: none"
    >
      <i class="fas fa-times" style="font-size: 1.25rem"></i>
    </a>
  </div>

  <div class="chat-messages" id="chat-messages">
    {% if messages %} {% for msg in messages %}
    <div
      class="message {% if msg.sender == request.user %}sent{% else %}received{% endif %}"
    >
      <div>{{ msg.content }}</div>
      <div class="message-time">{{ msg.timestamp|time:"g:i A" }}</div>
    </div>
    {% endfor %} {% else %}
    <div class="empty-chat">
      <i class="fas fa-comments"></i>
      <p>No messages yet. Start the conversation!</p>
    </div>
    {% endif %}
  </div>

  <form class="chat-input" id="chat-form" onsubmit="return sendMessage(event);">
    <input
      type="text"
      id="message-input"
      placeholder="Type your message..."
      autocomplete="off"
      required
    />
    <button type="submit"><i class="fas fa-paper-plane"></i> Send</button>
  </form>
</div>

<script>
  // WebSocket connection
  const conversationId = {{ conversation.id }};
  const currentUserId = {{ request.user.id }};
  const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const chatSocket = new WebSocket(
      wsScheme + '://' + window.location.host + '/ws/counsel/' + conversationId + '/'
  );

  const messagesContainer = document.getElementById('chat-messages');
  const messageInput = document.getElementById('message-input');

  // Scroll to bottom
  function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  scrollToBottom();

  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);

      if (data.type === 'message') {
          // Remove empty state if present
          const emptyChat = messagesContainer.querySelector('.empty-chat');
          if (emptyChat) emptyChat.remove();

          // Add message to chat
          const messageDiv = document.createElement('div');
          messageDiv.className = 'message ' + (data.sender_id === currentUserId ? 'sent' : 'received');

          const time = new Date(data.timestamp);
          const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

          messageDiv.innerHTML = `
              <div>${escapeHtml(data.message)}</div>
              <div class="message-time">${timeStr}</div>
          `;

          messagesContainer.appendChild(messageDiv);
          scrollToBottom();
      }
  };

  chatSocket.onclose = function(e) {
      console.log('Chat socket closed unexpectedly');
  };

  function sendMessage(e) {
      e.preventDefault();
      const message = messageInput.value.trim();

      if (message && chatSocket.readyState === WebSocket.OPEN) {
          chatSocket.send(JSON.stringify({ 'message': message }));
          messageInput.value = '';
      }
      return false;
  }

  function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
  }

  // Focus input on load
  messageInput.focus();
</script>
{% endblock %}
