{% extends 'dashboard/base.html' %}

{% block header_title %}Chat: {{ conversation.user.get_full_name|default:conversation.user.username }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        height: calc(100vh - 180px);
        min-height: 500px;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: #f8fafc;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: #fafafa;
    }

    .message {
        max-width: 75%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        line-height: 1.5;
        word-wrap: break-word;
        position: relative;
    }

    .message.chat-message-sent {
        align-self: flex-end;
        background: #1e3a8a; /* Darker blue */
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-left: 20%; /* visual distinction */
    }

    .message.chat-message-received {
        align-self: flex-start;
        background: #f3f4f6; /* Light gray */
        color: #1f2937;
        border-bottom-left-radius: 4px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-right: 20%; /* visual distinction */
    }

    .message-content {
        white-space: pre-wrap;
    }

    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }

    .message-actions {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
        display: none;
        gap: 0.25rem;
    }

    .message.chat-message-sent:hover .message-actions {
        display: flex;
    }

    .message-actions button {
        background: rgba(255,255,255,0.2);
        border: none;
        padding: 0.25rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.7rem;
        color: inherit;
    }

    .message-actions button:hover {
        background: rgba(255,255,255,0.4);
    }

    .message-edited {
        font-size: 0.65rem;
        font-style: italic;
        opacity: 0.6;
    }

    .chat-input-form {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        background: #f8fafc;
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .chat-input-form input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 25px;
        font-size: 1rem;
        outline: none;
        background: white;
    }

    .chat-input-form input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }

    .chat-input-form button {
        padding: 0.75rem 1.5rem;
        background: #1a1a2e;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chat-input-form button:hover {
        background: #2d2d4a;
    }

    .empty-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        text-align: center;
        padding: 2rem;
    }

    .empty-chat i {
        font-size: 3rem;
        opacity: 0.5;
        margin-bottom: 1rem;
    }

    .connection-status {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .connection-status.connected {
        background: #d1fae5;
        color: #065f46;
    }

    .connection-status.disconnected {
        background: #fee2e2;
        color: #b91c1c;
    }

    .btn-close-session {
        padding: 0.5rem 1rem;
        background: #fee2e2;
        color: #b91c1c;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.85rem;
    }

    .btn-close-session:hover {
        background: #fecaca;
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 900px;">
    <div class="chat-container">
        <div class="chat-header">
            <div>
                <strong style="font-family: var(--font-heading);">
                    {{ conversation.user.get_full_name|default:conversation.user.username }}
                </strong>
                <div style="font-size: 0.8rem; color: #6b7280;">
                    {% if conversation.retention_mode == '24h' %}
                        <i class="fas fa-clock"></i> Messages auto-delete after 24 hours
                    {% else %}
                        <i class="fas fa-lock"></i> Confidential conversation
                    {% endif %}
                    &bull; Started {{ conversation.created_at|timesince }} ago
                </div>
            </div>
            
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <span id="connection-status" class="connection-status disconnected">Connecting...</span>
                {% if conversation.is_active %}
                    <a href="{% url 'dashboard:counsel_close' conversation.id %}" class="btn-close-session" onclick="return confirm('Are you sure you want to close this session? This action cannot be undone.');">
                        <i class="fas fa-times"></i> Close Session
                    </a>
                {% endif %}
                <a href="{% url 'dashboard:counsel_sessions' %}" style="color: #6b7280;">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            {% for msg in chat_messages %}
                <div class="message {% if msg.sender_id == request.user.id %}chat-message-sent{% else %}chat-message-received{% endif %}" data-message-id="{{ msg.id }}">
                    {% if msg.sender_id == request.user.id %}
                    <div class="message-actions">
                        <button onclick="editMessage({{ msg.id }})" title="Edit"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteMessage({{ msg.id }})" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                    {% endif %}
                    <div class="message-content">{{ msg.content }}</div>
                    <div class="message-time">
                        {{ msg.timestamp|time:"g:i A" }}
                        {% if msg.edited_at %}<span class="message-edited">(edited)</span>{% endif %}
                    </div>
                </div>
            {% empty %}
                <div class="empty-chat" id="empty-chat">
                    <i class="fas fa-comments"></i>
                    <p>No messages yet. The user is waiting for your response.</p>
                </div>
            {% endfor %}
        </div>

        {% if conversation.is_active %}
        <form class="chat-input-form" id="chat-form">
            <input 
                type="text" 
                id="message-input" 
                placeholder="Type your response..." 
                autocomplete="off"
            />
            <button type="submit">
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </form>
        {% else %}
        <div class="chat-input-form" style="justify-content: center; color: #9ca3af;">
            <i class="fas fa-lock"></i>&nbsp; This conversation is closed
        </div>
        {% endif %}
    </div>
</div>

{% if conversation.is_active %}
<script>
    const conversationId = {{ conversation.id }};
    const currentUserId = {{ request.user.id }};
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const csrfToken = '{{ csrf_token }}';

    const messagesContainer = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const chatForm = document.getElementById('chat-form');
    const statusIndicator = document.getElementById('connection-status');

    let chatSocket = null;

    function connectWebSocket() {
        const wsUrl = wsScheme + '://' + window.location.host + '/ws/counsel/' + conversationId + '/';

        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function(e) {
            statusIndicator.textContent = 'Connected';
            statusIndicator.className = 'connection-status connected';
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if (data.type === 'message') {
                const emptyChat = document.getElementById('empty-chat');
                if (emptyChat) emptyChat.remove();

                const messageDiv = document.createElement('div');
                const isSent = data.sender_id === currentUserId;
                messageDiv.className = 'message ' + (isSent ? 'chat-message-sent' : 'chat-message-received');
                messageDiv.setAttribute('data-message-id', data.message_id);

                const time = new Date(data.timestamp);
                const timeStr = time.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit'
                });

                let actionsHtml = '';
                if (isSent) {
                    actionsHtml = `
                        <div class="message-actions">
                            <button onclick="editMessage(${data.message_id})" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteMessage(${data.message_id})" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    ${actionsHtml}
                    <div class="message-content">${escapeHtml(data.message)}</div>
                    <div class="message-time">${timeStr}</div>
                `;

                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }
            else if (data.type === 'message_edited') {
                const msgDiv = document.querySelector(`[data-message-id="${data.message_id}"]`);
                if (msgDiv) {
                    const contentDiv = msgDiv.querySelector('.message-content');
                    contentDiv.textContent = data.content;
                    const timeDiv = msgDiv.querySelector('.message-time');
                    if (!timeDiv.querySelector('.message-edited')) {
                        timeDiv.innerHTML += ' <span class="message-edited">(edited)</span>';
                    }
                }
            }
            else if (data.type === 'message_deleted') {
                const msgDiv = document.querySelector(`[data-message-id="${data.message_id}"]`);
                if (msgDiv) {
                    msgDiv.style.opacity = '0'; // Fade out effect
                    setTimeout(() => msgDiv.remove(), 300);
                }
            }
        };

        chatSocket.onclose = function(e) {
            statusIndicator.textContent = 'Disconnected';
            statusIndicator.className = 'connection-status disconnected';
            setTimeout(connectWebSocket, 3000);
        };

        chatSocket.onerror = function(e) {};
    }

    connectWebSocket();

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    scrollToBottom();

    function sendMessage() {
        const message = messageInput.value.trim();

        if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({ 'message': message }));
            messageInput.value = '';
        } else if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
            alert('Connection lost. Please wait for reconnection.');
        }
    }

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });

    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function editMessage(messageId) {
        const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        const contentDiv = msgDiv.querySelector('.message-content');
        const currentContent = contentDiv.textContent;
        
        const newContent = prompt('Edit message:', currentContent);
        if (newContent && newContent.trim() !== currentContent) {
            fetch(`/counsel/api/message/${messageId}/edit/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ content: newContent.trim() })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update happens via WebSocket, but update locally for instant feedback if needed
                    // though we rely on WS now.
                } else {
                    alert(data.error || 'Failed to edit message');
                }
            })
            .catch(err => alert('Error editing message'));
        }
    }

    function deleteMessage(messageId) {
        if (!confirm('Delete this message?')) return;
        
        fetch(`/counsel/api/message/${messageId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
               // Update happens via WebSocket
            } else {
                alert(data.error || 'Failed to delete message');
            }
        })
        .catch(err => alert('Error deleting message'));
    }

    messageInput.focus();
</script>
{% endif %}
{% endblock %}